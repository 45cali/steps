kind: step-type
version: '1.0'
metadata:
  name: cf-support/aws-cdk
  version: 1.94.1
  isPublic: false
  description: Integration with AWS Cloud Development Kit.
  sources:
    - https://github.com/codefresh-io/steps/tree/master/incubating/aws-cdk
  stage: incubating
  maintainers:
    - name: Francisco Cocozza,Laurent Rochette, LUkas Goodfellow
    - email: francisco@codefresh.io, laurent.rochette@codefresh.io, lukas.goodfellow@codefresh.io
  categories:
    - utilities
    - deployment
    - build
  official: false
  tags: []
  icon:
    type: image
    url: https://cdn.jsdelivr.net/gh/codefresh-io/steps/incubating/aws-cdk/icon.png
  examples:
    - description: aws-cdk
      workflow:
        AwsCDKSynth:
          title: "Build the app"
          type: aws-cdk
          arguments:
            ARG1: TBD
            ARG2: TBD
spec:
  arguments: |-
    {
      "definitions": {},
      "$schema": "http://json-schema.org/draft-07/schema#",
      "type": "object",
      "additionalProperties": true,
      "patterns": [],
      "required": [
        "action",
        "language"
      ],
      "properties": {
        "action": {
          "type": "string",
          "description": "The CDK operation to execute. Value can be synth, bootstrap, deploy, diff, list, destroy, freestyle"
        },
        "project_dir": {
          "type": "string",
          "description": "the path where the CDK application is located"
        },
        "language": {
          "type": "string",
          "default": "TypeScript",
          "examples": ["TypeScript", "python"],
          "description": "The language of the applciation. Default is TypeScript"
        },
        "debug": {
          "type": "boolean",
          "description": "Add the --verbose flag if true"
        },
        "cmd_ps": {
          "type": "string",
          "description": "Additional flags to pass to the aws cdk command"
        },
        "cdk_version": {
           "type": "string",
            "examples": ["1.91.0", "1.94.1"],
            "default": "1.94.1",
            "description": "Version of AWS CDK"
        },
        "commands": {
          "type": "array",
          "items": {
             "type": "string"
          },
          "description": "Commands to execute in plugin container for `freestyle` action)"
        }
      }
    }
  returns: |-
    {
        "definitions": {},
        "$schema": "http://json-schema.org/draft-07/schema#",
        "type": "object",
        "additionalProperties": true,
        "patterns": [],
        "required": [
          "STATUS"
        ],
        "properties": {
            "STATUS": {
                "type": "number",
                "description": "exit code. 0 indicates success"
            },
            "STATUS_JSON_FILE": {
                "type": "string",
                "description": "The path in the Codefresh Volume to the JSON answer from the ACTION performed."
            },
            "CLOUDFORMATION_FILE": {
                "type": "string",
                "description": "The path in the Codefresh Volume to the template saved as the cdk.out JSON file."
            }
        }
    }
  stepsTemplate: |-
    planner:
      name: aws-cdk-planner
      title: create the bash file to execute cdk action
      image: lrochette/aws-cdk-planner:[[ .Arguments.cdk_version ]]
    [[/* Executor for TypeScript */]]
    [[ if .Arguments.language eq "TypeScript" ]]
    execute-typescript:
      name: aws-cdk-executor-typescript
      title: execute commands for Typescript
      image: lrochette/aws-cdk-executor-typescript:[[ .Arguments.cdk_version ]]
      commands:
        - ./aws-cdk_script.sh
    [[ end ]]
    outputValues:
      name: setOutputValues
      title: Set the output values for the step
      image: alpine:latest
      commands:
        - cf_export STATUS=0
        - cf_export STATUS_JSON_FILE=/codefresh/volume/aws-cdk-result.json
        - cf_export CLOUDFORMATION_FILE=/codefresh/volume/cdk.out
        - exit 0
  delimiters:
    left: '[['
    right: ']]'

  # stepsTemplate: |-
  #   aws-cdk:
  #     name: aws-cdk
  #     image: lrochette/aws-cdk
  #     environment:
  #     [[ range $key, $val := .Arguments ]]
  #       - '[[ $key ]]=[[ $val ]]'
  #     [[- end ]]
  #     commands:
  #       - env
