kind: step-type
version: '1.0'
metadata:
  name: codefreshdemo/yaml-gitops-editor
  version: 1.0.0
  isPublic: false
  description: Edit YAML files and commit to Version Control System
  sources:
    - https://github.com/codefresh-io/steps/tree/master/incubating/yaml-gitops-editor
  stage: incubating
  maintainers:
    - name: Dustin Van Buskirk
      email: dustin@codefresh.io
  categories:
    - utilities
  official: true
  tags: []
  examples:
    - description: edit-values-in-yaml-and-commit
      workflow:
        EditYAMLFile:
          type: codefreshdemo/yaml-gitops-editor
          arguments:
            GIT_CONTEXT: github
            YAMLFILE: mymanifest.yml
            KEYVALUE_PAIRS:
              - services.myservice.environment.VARNAME1=VARVALUE1
              - services.myservice.environment.VARNAME2=VARVALUE2
    - description: edit-values-in-yaml-and-commit-open-github-pr
      workflow:
        EditYAMLFile:
          type: codefreshdemo/yaml-gitops-editor
          arguments:
            CREATE_PULL_REQUEST: true
            TARGET_BRANCH: main
            GIT_CONTEXT: github
            YAMLFILE: mymanifest.yml
            KEYVALUE_PAIRS:
              - services.myservice.environment.VARNAME1=VARVALUE1
              - services.myservice.environment.VARNAME2=VARVALUE2
spec:
  arguments: |-
    {
      "definitions": {},
      "$schema": "http://json-schema.org/draft-07/schema#",
      "type": "object",
      "additionalProperties": false,
      "patterns": [],
      "required": [],
      "properties": {
        "CF_BRANCH": {
          "type": "string",
          "description": "Branch for commit."
        },
        "CREATE_PULL_REQUEST": {
          "type": "boolean",
          "description": "If true, creates a pull request in GitHub to TARGET_BRANCH."
        },
        "CF_API_KEY": {
          "type": "string",
          "description": "Codefresh API Key."
        },
        "CF_BUILD_ID": {
          "type": "string",
          "description": "Codefresh Build ID."
        },
        "CF_REPO_NAME": {
          "type": "string",
          "description": "GitHub repository name."
        },
        "CF_REPO_OWNER": {
          "type": "string",
          "description": "GitHub organization."
        },
        "CF_VOLUME_PATH": {
          "type": "string",
          "description": "Base volume path."
        },
        "CODEFRESH_URL": {
          "type": "string",
          "description": "Base volume path.",
          "default": "https://g.codefresh.io"
        },
        "GIT_CONTEXT": {
          "type": "string",
          "description": "Name of GIT context in Codefresh"
        },
        "KEYVALUE_PAIRS": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "The YAML hierarchy is delimited with '.'' characters"
        },
        "TARGET_BRANCH": {
          "type": "string",
          "description": "GIT branch to target for pull request."
        },
        "YAMLFILE": {
          "type": "string",
          "description": "Composition file name.",
          "default": "docker-compose.yml"
        }
      }
    }
  stepsTemplate: |-
    composition-editor:
      name: yaml-gitops-editor
      image: dustinvanbuskirk/yaml-gitops-editor:1.0.0
      environment:
      [[ range $key, $val := .Arguments ]]
        - '[[ $key ]]=[[ $val ]]'
      [[- end ]]
      commands:
      [[ range $arg := .Arguments.KEYVALUE_PAIRS ]]
        - EDIT_OBJECT=value PAYLOAD='[[ $arg ]]' python3 /yaml-editor.py
      [[- end ]]
      [[ if .Arguments.GIT_CONTEXT ]]
        - python3 /git-committer.py
      [[- end]]
  delimiters:
    left: '[['
    right: ']]'
